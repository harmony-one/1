on: [push]

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get changed directories
        id: set-matrix
        run: |
          echo "Finding changed directories..."
          CHANGED_DIRS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^.*\/' | awk -F/ '{print $1}' | sort -u)
          DIRS=()
          for DIR in $CHANGED_DIRS; do
            if [[ "$DIR" == "al" || "$DIR" == "jn" || "$DIR" == "tf" || "$DIR" == "sa" ]]; then
              DIRS+=("{\"dir\":\"$DIR\"}")
            fi
          done
          DIRS_JSON=$(IFS=, ; echo "[${DIRS[*]}]")
          echo "Changed directories: $DIRS_JSON"
          echo "::set-output name=matrix::${DIRS_JSON}"

  publish:
    needs: changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    name: Publish to Cloudflare Pages
    strategy:
      matrix: ${{fromJson(needs.changes.outputs.matrix)}}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Publish to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: YOUR_ACCOUNT_ID
          projectName: "${{ matrix.dir }}-1"
          directory: "${{ matrix.dir }}"
          branch: main
