on: [push]

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get changed directories
        id: set-matrix
        run: |
          CHANGED_DIRS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '^(al|jn|tf|sa)/' | awk -F/ '{print $1}' | sort -u | jq -R . | jq -cs .)
          if [ -z "$CHANGED_DIRS" ] || [ "$CHANGED_DIRS" == "[]" ]; then
            # Provide a default value to avoid errors when no changes are found
            CHANGED_DIRS='["none"]'
          fi
          echo "::set-output name=matrix::{\"dir\": $CHANGED_DIRS}"

  publish:
    needs: changes
    runs-on: ubuntu-latest
    if: ${{ fromJson(needs.changes.outputs.matrix).dir[0] != 'none' }}
    strategy:
      matrix: ${{fromJson(needs.changes.outputs.matrix)}}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Publish to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: YOUR_ACCOUNT_ID
          projectName: "${{ matrix.dir }}-1"
          directory: "${{ matrix.dir }}"
          branch: main
