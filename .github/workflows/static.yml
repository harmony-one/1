on: [push]

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get changed directories
        id: set-matrix
        run: |
          CHANGED_DIRS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^.*\/' | awk -F/ '{print $1}' | sort -u)
          DIRS=()
          for DIR in $CHANGED_DIRS; do
            if [[ "$DIR" == "al" || "$DIR" == "jn" || "$DIR" == "tf" || "$DIR" == "sa" ]]; then
              DIRS+=("{\"dir\":\"$DIR\"}")
            fi
          done
          DIRS_JSON=$(IFS=, ; echo "[${DIRS[*]}]")
          if [ -z "$DIRS_JSON" ]; then
            echo "::set-output name=matrix::{\"include\":[{\"dir\":\"none\"}]}"
          else
            echo "::set-output name=matrix::{\"include\":$DIRS_JSON}"
          fi

  publish:
    needs: changes
    runs-on: ubuntu-latest
    if: ${{ needs.changes.outputs.matrix != '{"include":[{"dir":"none"}]}' }}
    strategy:
      matrix: ${{fromJson(needs.changes.outputs.matrix)}}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Publish to Cloudflare Pages
        if: ${{ matrix.dir != 'none' }}
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: YOUR_ACCOUNT_ID
          projectName: "${{ matrix.dir }}-1"
          directory: "${{ matrix.dir }}"
          branch: main
